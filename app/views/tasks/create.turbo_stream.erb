<%# Show success notification %>
<%= turbo_stream.update "flash-messages" do %>
  <%= render "partials/turbo_notification", message: t('tasks.messages.created', name: @task.name) %>
<% end %>

<%# Show the post-creation modal %>
<%= turbo_stream.update "modal-container" do %>
  <%= render "modals/post_creation_modal",
             title: t('modals.post_creation.task.title'),
             message: t('modals.post_creation.task.message', name: @task.name),
             stay_path: business_project_task_path(@business, @project, @task),
             stay_text: t('modals.post_creation.stay_and_edit'),
             back_path: business_project_path(@business, @project),
             back_text: t('modals.post_creation.go_back') %>
<% end %>

<%# Reset track-changes state since form was successfully saved %>
<%= turbo_stream.append "modal-container" do %>
  <script>
    // Clear "unsaved changes" state from track-changes controller
    document.querySelectorAll('[data-controller~="track-changes"]').forEach(element => {
      const app = window.Stimulus || document.querySelector('[data-controller]')?.application;
      if (app) {
        const controller = app.getControllerForElementAndIdentifier(element, 'track-changes');
        if (controller && controller.skipNavigationPrompt) {
          controller.skipNavigationPrompt();
        }
      }
    });

    // Disable beforeunload warning as fallback
    window.onbeforeunload = null;
  </script>
<% end %>
