<!DOCTYPE html>
<html lang="<%= I18n.locale %>" class="dark" data-locale="<%= I18n.locale %>">
  <head>
    <title>Conormio</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-cache-control" content="no-cache">
    <% inline_i18n = {
         "inline_edit.finish_current_field" => t("inline_edit.finish_current_field"),
         "inline_edit.unsaved_changes" => t("inline_edit.unsaved_changes"),
         "inline_edit.saved_successfully" => t("inline_edit.saved_successfully"),
         "errors.messages.blank" => t("errors.messages.blank", default: "This field is required"),
         "errors.messages.validation_failed" => t("errors.messages.validation_failed", default: "Please fix the errors below"),
         "errors.messages.required" => t("errors.messages.required", default: "This field is required")
       }.to_json.html_safe %>
    <meta name="i18n" content='<%= inline_i18n %>'>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <!-- CSS Files -->
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
    <!-- Header partial equivalent -->
    <%= render "partials/header" %>
    <%= favicon_link_tag "favicon-32x32_con.png", rel: "icon", type: "image/png", sizes: "32x32" %>
    <%= Sentry.get_trace_propagation_meta.html_safe %>
  </head>
  <body class="bg-gray-50 dark:bg-gray-800 <%= 'bg-white dark:bg-gray-900' if params[:white_bg] %>" data-controller="loading">
    <%# Inline script to prevent FOUC - must run synchronously before body renders %>
    <% if user_signed_in? %>
      <script>
        (function() {
          const userId = '<%= current_user.id %>';

          // Function to apply toggle state to an element immediately
          function applyToggleState(section) {
            const sectionId = section.dataset.sectionId;
            if (!sectionId) return;

            const storageKey = `toggle_${userId}_${sectionId}`;
            const savedState = localStorage.getItem(storageKey);

            if (savedState === 'false') {
              // Collapsed state
              section.classList.add('toggle-collapsed');
              const checkbox = section.querySelector('[data-toggle-target="switch"]');
              if (checkbox) checkbox.checked = false;
            }

            // Mark as initialized
            section.classList.add('toggle-init');
          }

          // Apply state to all existing toggle sections immediately
          function initExistingToggles() {
            const sections = document.querySelectorAll('[data-controller~="toggle"]:not(.toggle-init)');
            sections.forEach(applyToggleState);
          }

          // Use MutationObserver to catch dynamically added toggle sections
          const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                  // Check if the node itself is a toggle section
                  if (node.matches && node.matches('[data-controller~="toggle"]:not(.toggle-init)')) {
                    applyToggleState(node);
                  }
                  // Check descendants
                  const sections = node.querySelectorAll && node.querySelectorAll('[data-controller~="toggle"]:not(.toggle-init)');
                  if (sections) sections.forEach(applyToggleState);
                }
              });
            });
          });

          // Start observing immediately
          observer.observe(document.documentElement, {
            childList: true,
            subtree: true
          });

          // Also init on DOM ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initExistingToggles);
          } else {
            initExistingToggles();
          }

          // Re-init on Turbo navigation
          document.addEventListener('turbo:load', initExistingToggles);
          document.addEventListener('turbo:render', initExistingToggles);
        })();
      </script>
    <% end %>
    <%# Global scale wrapper for 80% UI scaling %>
    <div id="app-scale-wrapper">
      <%# Global loading overlay %>
      <%= render "partials/loading_overlay" %>

      <%# Subscribe to Turbo Stream notifications %>
      <% if user_signed_in? %>
        <%= turbo_stream_from "notifications_#{current_user.id}" %>
      <% end %>
      <%# Regular server-side flash messages %>
      <div id="flash-messages"
           class="fixed left-1/2 transform -translate-x-1/2 z-50 transition-opacity duration-500"
           style="top: 1rem;">
        <%= render "partials/flash_messages" %>
      </div>
      <%# Toast controller anchor to ensure global listener connects %>
      <div data-controller="toast"></div>
      <%# Turbo Stream notifications container (real-time broadcasts) %>
      <div id="turbo-notifications"
           class="fixed left-1/2 transform -translate-x-1/2 z-50 transition-opacity duration-500"
           style="top: 1rem;">
        <%# Real-time notifications append here %>
      </div>
      <%# Modal container for dynamic modals %>
      <div id="modal-container"></div>
      <!-- Glavni wrapper za sadrÅ¾aj -->
      <main class="bg-gray-50 dark:bg-gray-900 min-h-screen flex flex-col">
        <% if controller_name.in?(["sessions", "passwords"]) ||
       (controller_name == "registrations" && !action_name.in?(["edit", "update"])) %>
        <div class="flex items-center justify-center flex-grow px-6">
          <div class="w-full flex flex-col items-center justify-center px-6 pt-8 mx-auto md:h-screen pt:mt-0 dark:bg-gray-900">
            <%= yield %>
          </div>
        </div>
      <% else %>
        <%= render "partials/navbar" %>
        <div class="flex pt-16 overflow-hidden bg-gray-50 dark:bg-gray-900">
          <%= render "partials/sidebar" %>
          <div id="main-content" class="relative w-full h-full overflow-y-auto bg-gray-50 dark:bg-gray-900 p-6">
            <%= yield %>
          </div>
        </div>
      <% end %>
    </main>
    </div><%# End app-scale-wrapper %>
</body>
</html>
