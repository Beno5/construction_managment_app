<section class="bg-gray-50 dark:bg-gray-900 pt-5" data-controller="toggle" data-section-id="subtask-norms" data-user-id="<%= current_user.id %>">
  <div class="mx-auto">
    <div class="bg-white dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow">
      <div class="p-4">
        <div class="flex items-center gap-4">
          <h2 class="text-l font-semibold text-gray-900 sm:text-2xl dark:text-white"><%= t("norms.title") %></h2>
          <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox"
                   id="norms-toggle"
                   checked
                   class="sr-only peer"
                   data-action="change->toggle#toggle"
                   data-toggle-target="switch">
            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600 dark:peer-checked:bg-blue-600"></div>
          </label>
        </div>
      </div>
      <div data-toggle-target="content" class="transition-all duration-300">
        <div class="flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0 md:space-x-4 p-4 pt-0">
          <div class="w-full md:w-1/2">
          <%= form_with url: business_norms_path, method: :get, data: { turbo_frame: "norms-frame", controller: "search" }, local: true do %>
            <%= hidden_field_tag :sub_task_id, @sub_task.id if @sub_task.present? %>
            <label for="search" class="sr-only">Search</label>
            <div class="relative mt-1 lg:w-64 xl:w-96">
              <input type="text" 
           name="search" 
           id="search" 
           placeholder="<%= t('table.search.norm', default: t('table.search.default')) %>"
           value="<%= params[:search] %>"
           <%= "disabled" if @sub_task.new_record? %>
           class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg 
                  block w-full p-2.5 
                  dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white
                  <%= @sub_task.new_record? ? 'cursor-not-allowed bg-gray-200 dark:bg-gray-600' : 'focus:ring-primary-500 focus:border-primary-500 dark:focus:ring-primary-500 dark:focus:border-primary-500' %>"
           data-action="<%= 'input->search#performSearch' unless @sub_task.new_record? %>">
            </div>
          <% end %>
          </div>
        </div>
        <turbo-frame id="norms-frame">
          <div class="overflow-x-auto"
         data-controller="norms"
         data-norms-subtask-id-value="<%= @sub_task.id %>">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" data-controller="sort">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
              <tr>
                <th scope="col" class="px-4 py-3">
                </th>
                <th scope="col" class="px-4 py-3" role="button" data-action="click->sort#sort" data-sort-target="header" data-sort-index="1">
                  <div class="flex items-center gap-1 cursor-pointer select-none">
                    <span><%= t('norms.form.name') %></span>
                    <span class="text-gray-400" aria-hidden="true" data-sort-target="arrow" data-sort-index="1">↕</span>
                  </div>
                </th>
                <th scope="col" class="px-4 py-3" role="button" data-action="click->sort#sort" data-sort-target="header" data-sort-index="2">
                  <div class="flex items-center gap-1 cursor-pointer select-none">
                    <span><%= t('norms.form.description') %></span>
                    <span class="text-gray-400" aria-hidden="true" data-sort-target="arrow" data-sort-index="2">↕</span>
                  </div>
                </th>
                <th scope="col" class="px-4 py-3" role="button" data-action="click->sort#sort" data-sort-target="header" data-sort-index="3">
                  <div class="flex items-center gap-1 cursor-pointer select-none">
                    <span><%= t('norms.form.norm_value') %></span>
                    <span class="text-gray-400" aria-hidden="true" data-sort-target="arrow" data-sort-index="3">↕</span>
                  </div>
                </th>
                <th scope="col" class="px-4 py-3" role="button" data-action="click->sort#sort" data-sort-target="header" data-sort-index="4">
                  <div class="flex items-center gap-1 cursor-pointer select-none">
                    <span><%= t('norms.form.norm_type') %></span>
                    <span class="text-gray-400" aria-hidden="true" data-sort-target="arrow" data-sort-index="4">↕</span>
                  </div>
                </th>
                <th scope="col" class="px-4 py-3" role="button" data-action="click->sort#sort" data-sort-target="header" data-sort-index="5">
                  <div class="flex items-center gap-1 cursor-pointer select-none">
                    <span><%= t('norms.form.subtype') %></span>
                    <span class="text-gray-400" aria-hidden="true" data-sort-target="arrow" data-sort-index="5">↕</span>
                  </div>
                </th>
                <th scope="col" class="px-4 py-3" role="button" data-action="click->sort#sort" data-sort-target="header" data-sort-index="6">
                  <div class="flex items-center gap-1 cursor-pointer select-none">
                    <span><%= t('norms.form.unit_of_measure') %></span>
                    <span class="text-gray-400" aria-hidden="true" data-sort-target="arrow" data-sort-index="6">↕</span>
                  </div>
                </th>
                <th scope="col" class="px-4 py-3" role="button" data-action="click->sort#sort" data-sort-target="header" data-sort-index="7">
                  <div class="flex items-center gap-1 cursor-pointer select-none">
                    <span><%= t('norms.form.info') %></span>
                    <span class="text-gray-400" aria-hidden="true" data-sort-target="arrow" data-sort-index="7">↕</span>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <% @norms&.each do |norm| %>
                <tr class="border-b dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700">
                  <td class="px-4 py-3" data-sort-value="<%= @pinned_norms.include?(norm) ? '1' : '0' %>">
                    <%= check_box_tag "selected_norm_ids[]", norm.id, @pinned_norms.include?(norm),
                        class: "norm-checkbox",
                        disabled: norm_disabled?(norm, @pinned_norms) || norm_disabled_by_unit?(norm, @pinned_norms),
                        data: {
                          action: "change->norms#trackSelection",
                          norm_type: norm.norm_type,
                          norm_subtype: norm.worker? ? norm.subtype : nil,
                          norm_unit: norm.unit_of_measure
                        }.compact %>
                  </td>
                  <td class="px-4 py-3" data-sort-value="<%= norm.name.to_s.downcase %>"><%= norm.name %></td>
                  <td class="px-4 py-3" data-sort-value="<%= norm.description.to_s.downcase %>"><%= norm.description&.truncate(50) %></td>
                  <td class="px-4 py-3" data-sort-value="<%= norm.norm_value.to_s.downcase %>"><%= norm.norm_value %></td>
                  <td class="px-4 py-3" data-sort-value="<%= t_enum(norm, :norm_type).to_s.downcase %>"><%= t_enum(norm, :norm_type) %></td>
                  <td class="px-4 py-3" data-sort-value="<%= t_enum(norm, :subtype).to_s.downcase %>"><%= t_enum(norm, :subtype) %></td>
                  <td class="px-4 py-3" data-sort-value="<%= norm.unit_of_measure.to_s.downcase %>"><%= norm.unit_of_measure %></td>
                  <td class="px-4 py-3" data-sort-value="<%= norm.info.to_s.downcase %>"><%= norm.info %></td>
                </tr>
              <% end %>
            </tbody>
            </table>
          </div>
          <%= render "partials/nav_pages", collection: norms, model_name: "Norms", turbo_frame_id: local_assigns[:frame_id] || "norms-frame" %>
        </turbo-frame>
      </div>
    </div>
  </div>
</section>
