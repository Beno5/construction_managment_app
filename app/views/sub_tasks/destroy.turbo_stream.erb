<%# Replace the subtasks table with updated data %>
<%= turbo_stream.replace "table_subtasks-frame" do %>
  <%= render partial: "partials/table",
             locals: {
               collection: @task.sub_tasks.ordered_by_position,
               columns: {
                 t('tasks.table.id') => ->(s) { s.show_position },
                 t('subtasks.form.name') => :name,
                 t('subtasks.form.planned_start_date') => ->(s) { I18n.l(s.planned_start_date, format: :long) if s.planned_start_date },
                 t('subtasks.form.planned_end_date') => ->(s) { I18n.l(s.planned_end_date, format: :long) if s.planned_end_date },
                 t('subtasks.form.custom_fields') => :custom_fields
               },
               turbo_frame_id: "subtasks-frame",
               model_name: "SubTasks",
               search_path: business_project_task_path(@current_business, @project, @task),
               new_path: new_business_project_task_sub_task_path(@current_business, @project, @task),
               show_path: ->(s) { business_project_task_sub_task_path(@current_business, @project, @task, s) },
               edit_path: ->(s) { edit_business_project_task_sub_task_path(@current_business, @project, @task, s) },
               delete_path: ->(s) { business_project_task_sub_task_path(@current_business, @project, @task, s) },
               actions: []
             } %>
<% end %>

<%# Update flash messages container with success notification %>
<%= turbo_stream.update "flash-messages" do %>
  <%= render "partials/turbo_notification", message: t('subtasks.messages.deleted', name: @sub_task.name) %>
<% end %>

<%# Trigger Gantt chart refresh %>
<%= turbo_stream.after "gantt_here" do %>
  <div data-controller="gantt-trigger"></div>
<% end %>

<%# If last subtask was deleted, unlock task fields by replacing the form fields %>
<% if @task.sub_tasks.empty? %>
  <%= turbo_stream.replace "task-form-fields" do %>
    <div id="task-form-fields" class="grid grid-cols-6 gap-6">
      <!-- Name -->
      <div class="col-span-6 sm:col-span-3">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          <%= t('tasks.form.name') %>*
        </label>
        <div class="shadow-sm bg-white border border-gray-300 text-gray-900 sm:text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600"
             data-controller="inline-edit"
             data-inline-edit-model-value="task"
             data-inline-edit-field-value="name"
             data-inline-edit-type-value="text"
             data-inline-edit-url-value="<%= business_project_task_path(@current_business, @project, @task) %>"
             data-inline-edit-original-value="<%= @task.name %>"
             data-inline-edit-record-updated-at-value="<%= @task.updated_at.iso8601 %>"
             data-inline-edit-required-value="true"
             data-action="click->inline-edit#activate"
             title="<%= t('tooltips.click_to_edit') %>">
          <%= @task.name %>
        </div>
      </div>

      <!-- Description -->
      <div class="col-span-6 sm:col-span-3">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          <%= t('tasks.form.description') %>
        </label>
        <div class="shadow-sm bg-white border border-gray-300 text-gray-900 sm:text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600"
             data-controller="inline-edit"
             data-inline-edit-model-value="task"
             data-inline-edit-field-value="description"
             data-inline-edit-type-value="textarea"
             data-inline-edit-url-value="<%= business_project_task_path(@current_business, @project, @task) %>"
             data-inline-edit-original-value="<%= @task.description %>"
             data-inline-edit-record-updated-at-value="<%= @task.updated_at.iso8601 %>"
             data-action="click->inline-edit#activate"
             title="<%= t('tooltips.click_to_edit') %>">
          <%= @task.description %>
        </div>
      </div>

      <!-- Planned Start Date -->
      <div class="col-span-6 sm:col-span-3">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          <%= t('tasks.form.planned_start_date') %>
        </label>
        <div class="shadow-sm bg-white border border-gray-300 text-gray-900 sm:text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600"
             data-controller="inline-edit"
             data-inline-edit-model-value="task"
             data-inline-edit-field-value="planned_start_date"
             data-inline-edit-type-value="date"
             data-inline-edit-url-value="<%= business_project_task_path(@current_business, @project, @task) %>"
             data-inline-edit-original-value="<%= @task.planned_start_date %>"
             data-inline-edit-record-updated-at-value="<%= @task.updated_at.iso8601 %>"
             data-action="click->inline-edit#activate"
             title="<%= t('tooltips.click_to_edit') %>">
          <%= @task.planned_start_date ? I18n.l(@task.planned_start_date) : '' %>
        </div>
      </div>

      <!-- Planned End Date -->
      <div class="col-span-6 sm:col-span-3">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          <%= t('tasks.form.planned_end_date') %>
        </label>
        <div class="shadow-sm bg-white border border-gray-300 text-gray-900 sm:text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600"
             data-controller="inline-edit"
             data-inline-edit-model-value="task"
             data-inline-edit-field-value="planned_end_date"
             data-inline-edit-type-value="date"
             data-inline-edit-url-value="<%= business_project_task_path(@current_business, @project, @task) %>"
             data-inline-edit-original-value="<%= @task.planned_end_date %>"
             data-inline-edit-record-updated-at-value="<%= @task.updated_at.iso8601 %>"
             data-action="click->inline-edit#activate"
             title="<%= t('tooltips.click_to_edit') %>">
          <%= @task.planned_end_date ? I18n.l(@task.planned_end_date) : '' %>
        </div>
      </div>

      <!-- Planned Cost -->
      <div class="col-span-6 sm:col-span-3">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          <%= t('tasks.form.planned_cost', currency: @project.business.currency_symbol) %>
        </label>
        <div class="shadow-sm bg-white border border-gray-300 text-gray-900 sm:text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600"
             data-controller="inline-edit"
             data-inline-edit-model-value="task"
             data-inline-edit-field-value="planned_cost"
             data-inline-edit-type-value="number"
             data-inline-edit-url-value="<%= business_project_task_path(@current_business, @project, @task) %>"
             data-inline-edit-original-value="<%= @task.planned_cost %>"
             data-inline-edit-record-updated-at-value="<%= @task.updated_at.iso8601 %>"
             data-action="click->inline-edit#activate"
             title="<%= t('tooltips.click_to_edit') %>">
          <%= @task.planned_cost %>
        </div>
      </div>

      <!-- Planned Cost from Resources (Read-only, calculated from subtasks) -->
      <div class="col-span-6 sm:col-span-3">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          <%= t('tasks.form.planned_cost_from_resources', currency: @project.business.currency_symbol) %>
        </label>
        <div class="shadow-sm bg-gray-200 border border-gray-300 text-gray-900 sm:text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white cursor-not-allowed">
          <%= number_with_precision(@task.planned_cost_from_resources || 0, precision: 2) %> <%= @project.business.currency_symbol %>
        </div>
      </div>

      <!-- Unit of Measure -->
      <div class="col-span-6 sm:col-span-3">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          <%= t('tasks.form.unit_of_measure') %>
        </label>
        <div class="shadow-sm bg-white border border-gray-300 text-gray-900 sm:text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600"
             data-controller="inline-edit"
             data-inline-edit-model-value="task"
             data-inline-edit-field-value="unit_of_measure"
             data-inline-edit-type-value="select"
             data-inline-edit-url-value="<%= business_project_task_path(@current_business, @project, @task) %>"
             data-inline-edit-original-value="<%= @task.unit_of_measure %>"
             data-inline-edit-record-updated-at-value="<%= @task.updated_at.iso8601 %>"
             data-inline-edit-options-value='<%= Task.unit_of_measures.keys.index_with { |k| t("activerecord.attributes.task.unit_of_measures.#{k}") }.merge("" => "").to_json %>'
             data-action="click->inline-edit#activate"
             title="<%= t('tooltips.click_to_edit') %>">
          <%= @task.unit_of_measure ? t("activerecord.attributes.task.unit_of_measures.#{@task.unit_of_measure}") : '' %>
        </div>
      </div>

      <!-- Quantity -->
      <div class="col-span-6 sm:col-span-3">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          <%= t('tasks.form.quantity') %>
        </label>
        <div class="shadow-sm bg-white border border-gray-300 text-gray-900 sm:text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600"
             data-controller="inline-edit"
             data-inline-edit-model-value="task"
             data-inline-edit-field-value="quantity"
             data-inline-edit-type-value="number"
             data-inline-edit-url-value="<%= business_project_task_path(@current_business, @project, @task) %>"
             data-inline-edit-original-value="<%= @task.quantity %>"
             data-inline-edit-record-updated-at-value="<%= @task.updated_at.iso8601 %>"
             data-action="click->inline-edit#activate"
             title="<%= t('tooltips.click_to_edit') %>">
          <%= @task.quantity %>
        </div>
      </div>

      <!-- Price per Unit -->
      <div class="col-span-6 sm:col-span-3">
        <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          <%= t('tasks.form.price_per_unit', currency: @project.business.currency_symbol) %>
        </label>
        <div class="shadow-sm bg-white border border-gray-300 text-gray-900 sm:text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600"
             data-controller="inline-edit"
             data-inline-edit-model-value="task"
             data-inline-edit-field-value="price_per_unit"
             data-inline-edit-type-value="number"
             data-inline-edit-url-value="<%= business_project_task_path(@current_business, @project, @task) %>"
             data-inline-edit-original-value="<%= @task.price_per_unit %>"
             data-inline-edit-record-updated-at-value="<%= @task.updated_at.iso8601 %>"
             data-action="click->inline-edit#activate"
             title="<%= t('tooltips.click_to_edit') %>">
          <%= @task.price_per_unit %>
        </div>
      </div>

      <!-- Custom Fields -->
      <div class="col-span-6">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4"><%= t('tasks.form.custom_fields') %></h3>
        <%= render 'partials/custom_fields',
              custom_fields: @task.custom_fields,
              model: 'task',
              record: @task,
              url: business_project_task_path(@current_business, @project, @task),
              form_mode: false %>
      </div>
    </div>
  <% end %>
<% end %>

